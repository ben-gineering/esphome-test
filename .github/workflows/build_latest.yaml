name: build_latest

on:
  push:
    branches:
      - develop
  workflow_dispatch:

permissions:
  contents: write

env:
  DEFAULT_PYTHON: "3.13.7"

jobs:
  build-firmware:
    uses: ./.github/workflows/build.yaml
    with:
      files: |
        esphome-test.yaml
      esphome-version: 2025.11.4
      release-summary: develop-branch

  create_artifact_matrix:
    name: Create artifact matrix
    needs:
      - build-firmware
    outputs:
      matrix: ${{ steps.artifacts.outputs.matrix }}
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4.1.8
        with:
          path: files

      - run: tree

      - name: Get artifact names
        id: artifacts
        run: |
          artifacts=$(ls --format=single-column files)
          echo "artifacts<<EOF" >> $GITHUB_OUTPUT
          echo "$artifacts" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "matrix=$(ls files | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

  publish-develop-prerelease:
    name: Publish develop-latest pre-release
    needs:
      - build-firmware
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: files

      - name: Collect files for release
        run: |
          mkdir -p build
          find files -name "*.ota.bin" -exec cp {} build/ \;
          find files -name "*.factory.bin" -exec cp {} build/ \;
          find files -name "*.elf" -exec cp {} build/ \;
          find files -name "manifest.json" -exec cp {} build/ \;
          # Generate MD5 files for OTA binaries
          shopt -s nullglob
          for f in build/*.ota.bin; do
            [ -e "$f" ] || continue
            md5sum "$f" | awk '{print $1}' > "${f%.ota.bin}.ota.md5"
          done
          echo "Collected files:" && ls -l build || true

      - name: Ensure develop-latest pre-release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view develop-latest --repo "${GITHUB_REPOSITORY}" >/dev/null 2>&1 || \
          gh release create develop-latest -t "Develop Latest" -n "Rolling pre-release for develop branch" -p --repo "${GITHUB_REPOSITORY}"

      - name: Upload assets (clobber)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          shopt -s nullglob
          files=(build/*.ota.bin build/*.ota.md5 build/*.factory.bin build/*.elf build/manifest.json)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No assets to upload"; exit 0; 
          fi
          gh release upload develop-latest "${files[@]}" --clobber --repo "${GITHUB_REPOSITORY}"
